# pest VS nom benchmarks

This repository contains the benchmarks used in [the comparison between pest and nom](https://github.com/pest-parser/pest/blob/4cdbfc767b05e0e21b3d1d7fb211139f8a6b93c4/README.md#sheer-performance).

All the files are in `benches/`:

- `benches/pest.rs` a pest parser generated by the official generator
- `benches/faster_pest.rs` a pest parser generated by the [faster-pest](https://github.com/mubelotix/faster-pest) generator
- `benches/nom.rs` is the [test JSON parser](https://github.com/Geal/nom/blob/b5d11591056b6acf93834dc26f863aff6559c8ac/benches/json.rs) for **nom 4**. This outdated version is remains because it greatly outperforms future versions.
- `benches/nom7.rs` is the [example JSON parser](https://github.com/rust-bakery/nom/blob/main/examples/json.rs) for **nom 7**
- `benches/ujson4c.rs`

Only benchmarks with names sharing the same suffix are comparable.

Benchmarks suffixed `_shallow` recognize the AST without building a Rust data structure.

## Results

```
$ cargo bench
   Compiling pestvsnom v0.1.0 (/home/mubelotix/projects/pestvsnom)
    Finished bench [optimized] target(s) in 2.99s
     Running unittests src/lib.rs (target/release/deps/pestvsnom-2d14982312dfc0a6)

running 0 tests

test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s

     Running benches/faster_pest.rs (target/release/deps/faster_pest-eaa3dd6af9f3282d)

running 4 tests
test faster_pest_canada         ... bench:  18,142,626 ns/iter (+/- 3,183,996)
test faster_pest_canada_shallow ... bench:   4,748,476 ns/iter (+/- 464,822)
test faster_pest_data           ... bench:      11,958 ns/iter (+/- 1,438)
test faster_pest_data_shallow   ... bench:       3,723 ns/iter (+/- 749)

test result: ok. 0 passed; 0 failed; 0 ignored; 4 measured; 0 filtered out; finished in 17.90s

     Running benches/nom.rs (target/release/deps/nom-d3dfb5d8351a655d)

running 2 tests
test old_nom_canada ... bench:  24,393,149 ns/iter (+/- 7,242,989)
test old_nom_data   ... bench:      20,980 ns/iter (+/- 4,954)

test result: ok. 0 passed; 0 failed; 0 ignored; 2 measured; 0 filtered out; finished in 11.61s

     Running benches/nom7.rs (target/release/deps/nom7-bd8cb13cfce73e5d)

running 2 tests
test nom_canada ... bench:  31,717,873 ns/iter (+/- 5,889,311)
test nom_data   ... bench:      32,541 ns/iter (+/- 13,311)

test result: ok. 0 passed; 0 failed; 0 ignored; 2 measured; 0 filtered out; finished in 14.65s

     Running benches/pest.rs (target/release/deps/pest-e827b200982d3f5d)

running 4 tests
test pest_canada_collect ... bench:  45,969,109 ns/iter (+/- 18,125,987)
test pest_canada_shallow ... bench:  37,530,503 ns/iter (+/- 6,918,013)
test pest_data_collect   ... bench:      34,236 ns/iter (+/- 14,407)
test pest_data_shallow   ... bench:      24,745 ns/iter (+/- 5,970)

test result: ok. 0 passed; 0 failed; 0 ignored; 4 measured; 0 filtered out; finished in 34.08s

     Running benches/ujson4c.rs (target/release/deps/ujson4c-8c134eb35b110d5a)

running 2 tests
test ujson4c_canada ... bench:   9,234,080 ns/iter (+/- 2,262,309)
test ujson4c_data   ... bench:      18,486 ns/iter (+/- 4,262)

test result: ok. 0 passed; 0 failed; 0 ignored; 2 measured; 0 filtered out; finished in 13.05s
```

From these results (run on a late `Intel® Core™ i7-6700HQ CPU @ 2.60GHz`, with `rustc 1.68.0-nightly (3020239de 2023-01-09)`), we can see that it takes pest as much time to recognize the AST as it takes nom to both recognize it *and* build the data structure. Nom outperforms pest code generated by the official generator. On the other hand, pest code generated by the faster-pest generator greatly beats everything else except `ujson4c` on large files. Indeed, it parses the `canada.json` file at 790% the speed of pest and 174% the speed of nom.
